(function($) {
    "use strict"

    $('.dropify').dropify();

    $('#btn_upload').click(function(){

        processing = true;
        $('div.content-body').block({ message: 'Mengupload data...' });

        $('.dropify').parse({
            config:{
                complete: function(results){
                    console.log("Result...", results);
                    var datas = results.data;

                    var startTime = new Date().getTime();
                    $('.progress-upload').removeClass('d-none');

                    // for(var i = 0; i < datas.length-1; i++) {
                    //     let data = datas[i];
                        
                    //     var valeur = Math.round((i/data.length)*100);
                    //     console.log('valeur', valeur);
                    //     console.log('data[i][6]', data[6]);
                    //     $('.progress-bar').css('width', valeur+'%').text(valeur + " %").attr('aria-valuenow', valeur);
                    //     $('.progress-upload .d-flex span').html('Mohon menunggu, mengupload Agenda '+data[6]+' ke Database...');              
                    //     $.post('../controller/pemasaran/simpanDaftung.php', {data: data[i]}, function(res){
                    //         console.log(res);
                    //     }, 'json' );

                    // }
                    var success_count=0;

                    uploadKeDB(datas, 1);

                    function uploadKeDB(data, idx){

                        var valeur = Math.round((idx/data.length)*100);
                        var now = new Date().getTime();
                        var duration = ( now - startTime ) / 1000;
                        var tf_rate = (idx) / (duration);
                        tf_rate = Math.floor(tf_rate);
                        var estimasi = Math.ceil(((data.length-idx)/tf_rate)/60);
                        console.log('tf_rate', tf_rate);
                        console.log('valeur', valeur);
                        console.log('data[idx][6]', data[idx][6]);
                        $('.progress-bar').css('width', valeur+'%').text(valeur + " %").attr('aria-valuenow', valeur);

                        if(idx >= data.length - 1){
                            //$('.progress-upload').addClass('d-none');
                            $('.progress-upload .d-flex span.msg').html('Mohon menunggu, memindahkan agenda yang sudah keluar dari Daftung...');              
                            $('.progress-upload .d-flex span.info').html('...');              
                            
                            $.post('../controller/pemasaran/cleansingDaftung.php', {startTime: startTime}, function(res){
                                console.log(res);

                                if(res.success || res.success=='true'){
                                    $('.progress-upload .d-flex span.msg').html('Proses selesai');    
                                    $('.progress-upload .d-flex span.info').html('');   
                                    $('div#result').html($('div#result').html()+'<br/>'+'<span class="text-success">Update data selesai, '+success_count+' agenda berhasil diupload</span>');
                                }

                                $('div.content-body').unblock();
                                processing = false;

                            }, 'json' );

                        }else{

                            $('.progress-upload .d-flex span.msg').html('Mohon menunggu, mengupload Agenda '+data[idx][6]+' ke Database...');              
                            $('.progress-upload .d-flex span.info').html('Estimasi: '+estimasi+' menit (Transfer rate: '+tf_rate+' record / detik)');              
                            $.post('../controller/pemasaran/simpanDaftung.php', {data: data[idx], startTime: startTime}, function(res){
                                console.log(res);

                                if(!res.success || res.success=='false'){
                                    $('div#result').html($('div#result').html()+'<br/>'+'<span class="text-danger">'+res.noagenda+'</span>');
                                }else{
                                    success_count++;
                                }

                                idx = idx+1;
                                uploadKeDB(data, idx);
                            }, 'json' );
                        }
                    }
                },
            },
            before: function(file, inputElem)
            {
                //start = now();
                console.log("Parsing file...", file);
            },
            error: function(err, file)
            {
                console.log("ERROR:", err, file);
                firstError = firstError || err;
                errorCount++;
            },
            complete: function()
            {
                //console.log("Result...", results);
                // end = now();
                // printStats("Done with all files");
            }
        });
    });

    $('iframe#daftung_ap2t').attr('src','blank.html');

    $('#btn_cari').click(function(){

        $('div.content-body').block({ message: 'Mengambil data...' });
        var unitupi = $('#sel_unitupi').val();
        if(unitupi=='00') unitupi = 'SEMUA';
        var unitap = $('#sel_unitap').val();
        if(unitap=='00') unitap = 'SEMUA';

        $('iframe#daftung_ap2t').attr('src','https://ap2t.pln.co.id/cube/laporan.aspx?jenis=rekap_daftung_h_dtl&parameter=%27SEMUA%27;%27'+unitap+'%27;%27'+unitupi+'%27;%27');
    
        $('iframe#daftung_ap2t').on('load', function(){
            //$(this).show();
            $('div.content-body').unblock();
        });
    });

    window.onbeforeunload = confirmExit;
    function confirmExit() {
        if(processing)
            return "Anda masih memiliki proses upload yang belum selesai. Apakah anda yakin untuk keluar halaman ini?";
    }


})(jQuery);